var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=exports.QueueProvider=exports.fetchWorker=exports.fetchLocalImage=exports.fetchRemoteImage=exports.checkLocalImage=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _reactNativeFs=_interopRequireDefault(require("react-native-fs"));var _priorityQueue=_interopRequireDefault(require("async/priorityQueue"));var _asyncify=_interopRequireDefault(require("async/asyncify"));var checkLocalImage=function checkLocalImage(path){return _regenerator.default.async(function checkLocalImage$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return _regenerator.default.awrap(_reactNativeFs.default.exists(path));case 2:return _context.abrupt("return",_context.sent);case 3:case"end":return _context.stop();}}},null,null,null,Promise);};exports.checkLocalImage=checkLocalImage;var fetchRemoteImage=function fetchRemoteImage(_ref){var signature,progressCallback,requestCallback,failureCallback,successCallback,_RNFS$downloadFile,promise,jobId,response;return _regenerator.default.async(function fetchRemoteImage$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:signature=_ref.signature,progressCallback=_ref.progressCallback,requestCallback=_ref.requestCallback,failureCallback=_ref.failureCallback,successCallback=_ref.successCallback;_context2.next=3;return _regenerator.default.awrap(_reactNativeFs.default.mkdir(signature.pathFolder));case 3:_RNFS$downloadFile=_reactNativeFs.default.downloadFile({fromUrl:signature.source,toFile:signature.path,background:false,discretionary:true,cacheable:false,readTimeout:30000,backgroundTimeout:30000,progressDivider:20,resumable:function resumable(){return _reactNativeFs.default.isResumable(jobId).then(function(){return _reactNativeFs.default.resumeDownload(jobId);});},begin:requestCallback,progress:progressCallback}),promise=_RNFS$downloadFile.promise,jobId=_RNFS$downloadFile.jobId;_context2.prev=4;_context2.next=7;return _regenerator.default.awrap(promise);case 7:response=_context2.sent;if(!(response.statusCode!==200)){_context2.next=10;break;}throw new Error("http error "+response.statusCode);case 10:return _context2.abrupt("return",successCallback({jobId:jobId,signature:signature,response:response}));case 13:_context2.prev=13;_context2.t0=_context2["catch"](4);return _context2.abrupt("return",failureCallback({jobId:jobId,signature:signature,error:_context2.t0}));case 16:case"end":return _context2.stop();}}},null,null,[[4,13]],Promise);};exports.fetchRemoteImage=fetchRemoteImage;var fetchLocalImage=function fetchLocalImage(_ref2){var signature,failureCallback,requestCallback,successCallback;return _regenerator.default.async(function fetchLocalImage$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:signature=_ref2.signature,failureCallback=_ref2.failureCallback,requestCallback=_ref2.requestCallback,successCallback=_ref2.successCallback;requestCallback();successCallback();case 3:case"end":return _context3.stop();}}},null,null,null,Promise);};exports.fetchLocalImage=fetchLocalImage;var fetchWorker=function fetchWorker(trackerProvider,checkLocalImage,fetchLocalImage,fetchRemoteImage){return(0,_asyncify.default)(function _callee(task){var requestCallback,progressCallback,failureCallback,successCallback;return _regenerator.default.async(function _callee$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:requestCallback=function requestCallback(){trackerProvider.incrementPointer(task.groupHash,'pointerLoading');trackerProvider.progress(task.groupHash,0.1);};progressCallback=function progressCallback(data){var progress=parseInt(data.bytesWritten/data.contentLength*100,10);trackerProvider.progress(task.groupHash,progress);};failureCallback=function failureCallback(){trackerProvider.failure(task.groupHash);};successCallback=function successCallback(){trackerProvider.incrementPointer(task.groupHash,'pointerSuccess');trackerProvider.success(task.groupHash);console.log('success');};_context4.next=6;return _regenerator.default.awrap(checkLocalImage(task.signature.path));case 6:if(!_context4.sent){_context4.next=11;break;}_context4.next=9;return _regenerator.default.awrap(fetchLocalImage({signature:task.signature,progressCallback:progressCallback,requestCallback:requestCallback,failureCallback:failureCallback,successCallback:successCallback}));case 9:_context4.next=13;break;case 11:_context4.next=13;return _regenerator.default.awrap(fetchRemoteImage({signature:task.signature,progressCallback:progressCallback,requestCallback:requestCallback,failureCallback:failureCallback,successCallback:successCallback}));case 13:case"end":return _context4.stop();}}},null,null,null,Promise);});};exports.fetchWorker=fetchWorker;var QueueProvider=function QueueProvider(trackerProvider,fetchQueueWorker){var priority=1;var fetchQueue=(0,_priorityQueue.default)(fetchQueueWorker,1);var push=function push(groupHash,signature){return _regenerator.default.async(function push$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(!trackerProvider.getAssetByPath(groupHash,signature)){trackerProvider.queue(groupHash,signature);}if(trackerProvider.shouldInitializeDownload(groupHash)||trackerProvider.shouldContinueDownload(groupHash)){console.log(trackerProvider.shouldInitializeDownload(groupHash),trackerProvider.shouldContinueDownload(groupHash));fetchQueue.push({groupHash:groupHash,signature:signature},priority,function(){push(groupHash,trackerProvider.getAssetByCurrentPointer(groupHash,1));});}case 2:case"end":return _context5.stop();}}},null,null,null,Promise);};return{fetchQueue:fetchQueue,push:push};};exports.QueueProvider=QueueProvider;var instance=null;var _default=function _default(StorageProvider){if(!instance){instance=QueueProvider(StorageProvider,fetchWorker(StorageProvider,checkLocalImage,fetchLocalImage,fetchRemoteImage));}return instance;};exports.default=_default;