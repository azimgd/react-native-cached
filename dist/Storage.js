var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=exports.TrackerProvider=exports.Selectors=exports.StorageProvider=void 0;var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){(0,_defineProperty2.default)(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}var StorageProvider=function StorageProvider(input){var storage=new Map(input);var observables=new Map();var has=function has(key){return storage.has(key);};var get=function get(key){return storage.get(key);};var set=function set(key,value){return storage.set(key,value);};var subscribe=function subscribe(key,callback){var current=observables.get(key)||[];observables.set(key,[].concat((0,_toConsumableArray2.default)(current),[callback]));return function(){var current=observables.get(key)||[];var modified=current.filter(function(s){return s!==callback;});if(modified.length){observables.set(key,modified);}else{observables.delete(key);}};};var dispatch=function dispatch(key){for(var _len=arguments.length,args=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}var current=observables.get(key)||[];current.map(function(callback){if(typeof callback==='function'){callback.apply(void 0,args);}});};return{has:has,get:get,set:set,subscribe:subscribe,dispatch:dispatch};};exports.StorageProvider=StorageProvider;var Selectors=function(){var clone=function clone(object){return{pointerSuccess:object.pointerSuccess,pointerLoading:object.pointerLoading,status:object.status,assets:object.assets.map(function(item){return _objectSpread({},item);})};};var createSchema=function createSchema(){return{assets:[],pointerSuccess:-1,pointerLoading:-1,status:'idle'};};var pushAsset=function pushAsset(object,value){object.assets.push(_objectSpread(_objectSpread({},value),{},{progress:0,updatedAt:null}));return object;};var getAssetByPath=function getAssetByPath(object,value){if(!object||!object.assets)return false;if(!value||!value.path)return false;return object.assets.find(function(item){return item.path===value.path;});};var shouldInitializeDownload=function shouldInitializeDownload(object){if(!object||!object.assets)return false;return object.assets.length===1&&object.assets[0].progress===0;};var shouldContinueDownload=function shouldContinueDownload(object){var _object$assets;if(!object||!object.assets)return false;if(object.assets.length===1||object.assets[0].progress===0)return false;return object.pointerLoading===object.pointerSuccess&&((_object$assets=object.assets[object.pointerSuccess+1])==null?void 0:_object$assets.path);};var getAssetByCurrentPointer=function getAssetByCurrentPointer(object,shifter){if(!object||!object.assets)return false;if(!object.assets[object.pointerSuccess+(shifter||0)])return undefined;return object.assets[object.pointerSuccess+(shifter||0)];};var setProgress=function setProgress(object,value){if(value<0||value>100)return object;object.assets[object.pointerLoading].progress=value;object.assets[object.pointerLoading].updatedAt=Date.now();return object;};var setStatus=function setStatus(object,value){if(!['idle','loading','success','failure'].includes(value))return object;object.status=value;return object;};var incrementPointer=function incrementPointer(object,type){if(!['pointerLoading','pointerSuccess'].includes(type))return object;if(object[type]+1>=object.assets.length)return object;object[type]+=1;return object;};var decrementPointer=function decrementPointer(object,type){if(!['pointerLoading','pointerSuccess'].includes(type))return object;if(object[type]-1<0)return object;object[type]-=1;return object;};return{clone:clone,createSchema:createSchema,getAssetByPath:getAssetByPath,shouldInitializeDownload:shouldInitializeDownload,shouldContinueDownload:shouldContinueDownload,getAssetByCurrentPointer:getAssetByCurrentPointer,pushAsset:pushAsset,setProgress:setProgress,setStatus:setStatus,incrementPointer:incrementPointer,decrementPointer:decrementPointer};}();exports.Selectors=Selectors;var TrackerProvider=function TrackerProvider(storage){var getAssetByPath=function getAssetByPath(key,signature){var current=storage.get(key);return Selectors.getAssetByPath(current,signature);};var getAssetByCurrentPointer=function getAssetByCurrentPointer(key,shifter){var current=storage.get(key);return Selectors.getAssetByCurrentPointer(current,shifter);};var shouldInitializeDownload=function shouldInitializeDownload(key){var current=storage.get(key);return Selectors.shouldInitializeDownload(current);};var shouldContinueDownload=function shouldContinueDownload(key){var current=storage.get(key);return Selectors.shouldContinueDownload(current);};var incrementPointer=function incrementPointer(key,type){var current=Selectors.clone(storage.get(key));Selectors.incrementPointer(current,type);storage.set(key,current);};var decrementPointer=function decrementPointer(key,type){var current=Selectors.clone(storage.get(key));Selectors.decrementPointer(current,type);storage.set(key,current);};var queue=function queue(key,signature){var current=storage.get(key)||Selectors.createSchema();Selectors.pushAsset(current,signature);storage.set(key,current);storage.dispatch(key,{type:'queue',value:current});};var progress=function progress(key,downloaded){if(!storage.has(key)||!downloaded||downloaded<0||downloaded>100)return;var current=Selectors.clone(storage.get(key));Selectors.setProgress(current,downloaded);Selectors.setStatus(current,'loading');storage.set(key,current);storage.dispatch(key,{type:'progress',value:current});};var success=function success(key){if(!storage.has(key))return;var current=Selectors.clone(storage.get(key));Selectors.setProgress(current,100);Selectors.setStatus(current,'success');storage.set(key,current);storage.dispatch(key,{type:'success',value:current});};var failure=function failure(key){if(!storage.has(key))return;var current=Selectors.clone(storage.get(key));Selectors.setProgress(current,0);Selectors.setStatus(current,'failure');storage.set(key,current);storage.dispatch(key,{type:'failure',value:current});};return{incrementPointer:incrementPointer,decrementPointer:decrementPointer,getAssetByPath:getAssetByPath,getAssetByCurrentPointer:getAssetByCurrentPointer,shouldInitializeDownload:shouldInitializeDownload,shouldContinueDownload:shouldContinueDownload,queue:queue,progress:progress,success:success,failure:failure};};exports.TrackerProvider=TrackerProvider;var adapter=function adapter(input){var storage=StorageProvider(input);var tracker=TrackerProvider(storage);return{incrementPointer:tracker.incrementPointer,decrementPointer:tracker.decrementPointer,getAssetByPath:tracker.getAssetByPath,getAssetByCurrentPointer:tracker.getAssetByCurrentPointer,shouldInitializeDownload:tracker.shouldInitializeDownload,shouldContinueDownload:tracker.shouldContinueDownload,queue:tracker.queue,progress:tracker.progress,success:tracker.success,failure:tracker.failure,subscribe:storage.subscribe};};var _default=adapter;exports.default=_default;